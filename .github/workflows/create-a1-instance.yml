name: Create A1 Amsterdam

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  create:
    runs-on: ubuntu-latest
    steps:
      - name: Install OCI CLI
        run: |
          curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh | bash -s -- --accept-all-defaults
          echo "$HOME/bin" >> $GITHUB_PATH
          
      - name: Configure OCI
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_CLI_KEY_CONTENT }}" > ~/.oci/key.pem
          chmod 600 ~/.oci/key.pem
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=${{ secrets.OCI_CLI_USER }}
          fingerprint=${{ secrets.OCI_CLI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_CLI_TENANCY }}
          region=${{ secrets.OCI_CLI_REGION }}
          key_file=~/.oci/key.pem
          EOF
          
      - name: Verify OCI config
        run: |
          echo "Testing OCI CLI connection..."
          $HOME/bin/oci iam region list --config-file ~/.oci/config || echo "Warning: Could not list regions"
          
      - name: Create Instance
        id: create_instance
        continue-on-error: true
        run: |
          echo "ðŸ” Attempting to create A1.Flex instance..."
          echo "Region: ${{ secrets.OCI_CLI_REGION }}"
          echo "AD: QYsH:eu-amsterdam-1-AD-1"
          
          # StwÃ³rz plik z SSH key (bezpieczniejsze niÅ¼ inline)
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > /tmp/ssh_key.pub
          
          $HOME/bin/oci compute instance launch \
            --availability-domain "QYsH:eu-amsterdam-1-AD-1" \
            --compartment-id "${{ secrets.OCI_CLI_TENANCY }}" \
            --shape "VM.Standard.A1.Flex" \
            --shape-config '{"ocpus":4,"memoryInGBs":24}' \
            --display-name "auto-a1-amsterdam" \
            --image-id "ocid1.image.oc1.eu-amsterdam-1.aaaaaaaaqgcxnnswli5zezdbr34rnrziqapp2ofggaztnl3ynwey4vbwygnq" \
            --subnet-id "${{ secrets.SUBNET_ID }}" \
            --assign-public-ip true \
            --ssh-authorized-keys-file /tmp/ssh_key.pub \
            --wait-for-state RUNNING \
            --max-wait-seconds 300 \
            2>&1 | tee output.log
          
          EXIT_CODE=$?
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Exit code: $EXIT_CODE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # SprawdÅº capacity
          if grep -Eiq "out of (host )?capacity|InsufficientCapacity" output.log; then
            echo "â³ No capacity available - will retry in 15 min"
            echo "instance_created=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # SprawdÅº inne bÅ‚Ä™dy
          if grep -iq "ServiceError" output.log; then
            echo "âŒ ServiceError detected:"
            grep -A 10 "ServiceError" output.log || true
            echo "instance_created=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if grep -iq "InvalidParameter" output.log; then
            echo "âŒ InvalidParameter - check your configuration:"
            grep -B 2 -A 5 "InvalidParameter" output.log || true
            echo "instance_created=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if grep -iq "NotAuthorizedOrNotFound" output.log; then
            echo "âŒ NotAuthorized - check your OCIDs (compartment, subnet, image):"
            grep -B 2 -A 5 "NotAuthorized" output.log || true
            echo "instance_created=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # SprawdÅº sukces
          if [ $EXIT_CODE -eq 0 ] && grep -q '"lifecycle-state": "RUNNING"' output.log; then
            echo "âœ… SUCCESS! Instance created and running!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            grep -E '"display-name"|"lifecycle-state"|"public-ip"|"id"' output.log | head -20 || true
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "instance_created=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Wszystko inne
          echo "âš ï¸ Unexpected result - full output:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          cat output.log
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "instance_created=false" >> $GITHUB_OUTPUT
          exit 0
      
      - name: Send email notification on success
        if: steps.create_instance.outputs.instance_created == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âœ… Oracle A1.Flex Instance Created!"
          to: ${{ secrets.EMAIL_USERNAME }}
          from: ${{ secrets.EMAIL_USERNAME }}
          body: |
            ðŸŽ‰ SUCCESS! Oracle A1.Flex instance created in Amsterdam!
            
            Go to: https://cloud.oracle.com
            Navigate to: Compute â†’ Instances
            Find: auto-a1-amsterdam
            
            DISABLE GitHub workflow immediately!
