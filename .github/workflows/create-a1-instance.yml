name: Create A1 Amsterdam

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  oci-task:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Cache OCI CLI
        uses: actions/cache@v3
        with:
          path: ~/.local
          key: ${{ runner.os }}-oci-cli
      
      - name: Install OCI CLI
        run: |
          pip install --user oci-cli
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      
      - name: Verify Installation
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          oci --version
      
      - name: Configure OCI
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_CLI_CONFIG }}" > ~/.oci/config
          echo "${{ secrets.OCI_CLI_KEY }}" > ~/.oci/key.pem
          chmod 600 ~/.oci/key.pem
      
      - name: Test Connection
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          oci os ns get
      
      - name: Run OCI Commands
        env:
          COMPARTMENT_ID: ${{ secrets.COMPARTMENT_ID }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          
          echo "üöÄ Uruchamianie komend OCI..."
          
          # ===================================
          # ARM Instance Capacity Check
          # ===================================
          
          # Sprawd≈∫ dostƒôpno≈õƒá ARM shapes
          echo "üìä Sprawdzanie dostƒôpno≈õci ARM instances..."
          
          oci compute shape list \
            --compartment-id "$COMPARTMENT_ID" \
            --all \
            --query 'data[?contains("processor-description", `Arm`) == `true`]' \
            --output table
          
          # Lista istniejƒÖcych instancji ARM
          echo ""
          echo "üìã IstniejƒÖce instancje ARM:"
          
          oci compute instance list \
            --compartment-id "$COMPARTMENT_ID" \
            --all \
            --query 'data[?contains(shape, `Ampere`) == `true`].{Name:"display-name", Shape:shape, State:"lifecycle-state"}' \
            --output table
          
          # Pr√≥ba utworzenia instancji (je≈õli to Tw√≥j cel)
          # echo ""
          # echo "üîß Pr√≥ba utworzenia instancji ARM..."
          # 
          # oci compute instance launch \
          #   --availability-domain "xxxx:EU-FRANKFURT-1-AD-1" \
          #   --compartment-id "$COMPARTMENT_ID" \
          #   --shape "VM.Standard.A1.Flex" \
          #   --shape-config '{"ocpus":4,"memoryInGBs":24}' \
          #   --image-id "ocid1.image.oc1.eu-frankfurt-1.xxx" \
          #   --subnet-id "${{ secrets.SUBNET_ID }}" \
          #   --display-name "arm-instance-$(date +%Y%m%d-%H%M%S)" \
          #   --wait-for-state RUNNING \
          #   || echo "‚ö†Ô∏è Brak dostƒôpnej capacity dla ARM"
          
          echo "‚úÖ Workflow zako≈Ñczony"
      
      - name: Cleanup
        if: always()
        run: rm -rf ~/.oci
