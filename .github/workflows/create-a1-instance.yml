name: Create A1 Amsterdam

on:
  schedule:
    - cron: '*/15 * * * *'  # Co 15 minut
  workflow_dispatch:        # MoÅ¼liwoÅ›Ä‡ rÄ™cznego uruchomienia
  push:
    branches:
      - master                # Uruchom przy push do main (opcjonalnie)

jobs:
  oci-task:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      # 1. Checkout repozytorium (jeÅ›li potrzebujesz plikÃ³w z repo)
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # 2. Konfiguracja Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # 3. Cache dla OCI CLI (przyspiesza kolejne uruchomienia)
      - name: Cache OCI CLI
        id: cache-oci
        uses: actions/cache@v3
        with:
          path: ~/.local
          key: ${{ runner.os }}-oci-cli-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-oci-cli-
      
      # 4. Instalacja OCI CLI
      - name: Install OCI CLI
        run: |
          echo "ðŸ“¦ Instalacja OCI CLI..."
          pip install --user oci-cli
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      
      # 5. Weryfikacja instalacji
      - name: Verify OCI CLI Installation
        run: |
          sleep 1
          export PATH="$HOME/.local/bin:$PATH"
          
          if command -v oci &> /dev/null; then
            echo "âœ… OCI CLI zainstalowane pomyÅ›lnie"
            echo "Wersja: $(oci --version)"
          else
            echo "âŒ OCI CLI nie znalezione"
            exit 1
          fi
      
      # 6. Konfiguracja OCI CLI
      - name: Configure OCI CLI
        env:
          OCI_CONFIG: ${{ secrets.OCI_CLI_CONFIG }}
          OCI_KEY: ${{ secrets.OCI_CLI_KEY }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          
          echo "ðŸ”§ Konfiguracja OCI CLI..."
          
          # SprawdÅº czy secrets sÄ… ustawione
          if [ -z "$OCI_CONFIG" ] || [ -z "$OCI_KEY" ]; then
            echo "âŒ Brak wymaganych secrets (OCI_CLI_CONFIG lub OCI_CLI_KEY)"
            exit 1
          fi
          
          # UtwÃ³rz katalog konfiguracyjny
          mkdir -p ~/.oci
          
          # Zapisz plik konfiguracyjny
          echo "$OCI_CONFIG" > ~/.oci/config
          
          # Zapisz klucz prywatny
          echo "$OCI_KEY" > ~/.oci/key.pem
          
          # Ustaw odpowiednie uprawnienia
          chmod 600 ~/.oci/key.pem
          chmod 600 ~/.oci/config
          
          echo "âœ… OCI CLI skonfigurowane"
      
      # 7. Test poÅ‚Ä…czenia z OCI
      - name: Test OCI Connection
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          
          echo "ðŸ” Testowanie poÅ‚Ä…czenia z OCI..."
          
          if oci os ns get; then
            echo "âœ… PoÅ‚Ä…czenie z OCI dziaÅ‚a poprawnie"
          else
            echo "âŒ Nie moÅ¼na poÅ‚Ä…czyÄ‡ siÄ™ z OCI"
            exit 1
          fi
      
      # 8. GÅ‚Ã³wne zadania OCI
      - name: Run OCI Commands
        env:
          COMPARTMENT_ID: ${{ secrets.COMPARTMENT_ID }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          
          echo "ðŸš€ Uruchamianie komend OCI..."
          
          # ===================================
          # TUTAJ DODAJ SWOJE KOMENDY OCI
          # ===================================
          
          # PrzykÅ‚ad 1: Lista instancji compute
          echo "ðŸ“‹ Lista instancji compute:"
          oci compute instance list \
            --compartment-id "$COMPARTMENT_ID" \
            --output table \
            --query 'data[*].{Name:"display-name", State:"lifecycle-state", Shape:shape}' \
            || echo "âš ï¸  Brak instancji lub bÅ‚Ä…d"
          
          # PrzykÅ‚ad 2: Lista bucket'Ã³w
          echo ""
          echo "ðŸ“¦ Lista Object Storage buckets:"
          oci os bucket list \
            --compartment-id "$COMPARTMENT_ID" \
            --output table \
            || echo "âš ï¸  Brak buckets lub bÅ‚Ä…d"
          
          # PrzykÅ‚ad 3: Informacje o namespace
          echo ""
          echo "ðŸ“Œ Object Storage namespace:"
          oci os ns get
          
          # PrzykÅ‚ad 4: SprawdÅº limity i usage
          echo ""
          echo "ðŸ“Š Service limits:"
          oci limits value list \
            --compartment-id "$COMPARTMENT_ID" \
            --service-name compute \
            --all \
            --output table \
            || echo "âš ï¸  Nie moÅ¼na pobraÄ‡ limitÃ³w"
          
          # PrzykÅ‚ad 5: Eksport do JSON (jeÅ›li potrzebujesz przetwarzaÄ‡ dane)
          echo ""
          echo "ðŸ’¾ Zapisywanie danych do pliku..."
          oci compute instance list \
            --compartment-id "$COMPARTMENT_ID" \
            --output json > /tmp/instances.json
          
          echo "Liczba instancji: $(cat /tmp/instances.json | jq '.data | length')"
          
          echo ""
          echo "âœ… Wszystkie komendy OCI wykonane"
      
      # 9. Upload artefaktÃ³w (opcjonalnie - jeÅ›li chcesz zachowaÄ‡ wyniki)
      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: oci-results-${{ github.run_number }}
          path: |
            /tmp/*.json
            /tmp/*.log
          retention-days: 7
        continue-on-error: true
      
      # 10. Czyszczenie (bezpieczeÅ„stwo)
      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Czyszczenie..."
          rm -rf ~/.oci
          rm -f /tmp/*.json
          rm -f /tmp/*.log
          echo "âœ… Cleanup zakoÅ„czone"
      
      # 11. Podsumowanie
      - name: Summary
        if: always()
        run: |
          echo "ðŸ“ === PODSUMOWANIE ===" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Czas wykonania**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Runner**: ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
