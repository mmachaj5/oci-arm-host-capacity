name: OCI ARM Capacity Check

on:
  schedule:
    - cron: '*/15 * * * *'  # Co 15 minut
  workflow_dispatch:

jobs:
  check-capacity:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Cache OCI CLI
        uses: actions/cache@v3
        with:
          path: ~/.local
          key: ${{ runner.os }}-oci-cli-v1
      
      - name: Install OCI CLI
        run: |
          pip install --user oci-cli
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      
      - name: Verify OCI CLI Installation
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          oci --version
      
      - name: Configure OCI CLI
        env:
          OCI_CLI_USER: ${{ secrets.OCI_CLI_USER }}
          OCI_CLI_FINGERPRINT: ${{ secrets.OCI_CLI_FINGERPRINT }}
          OCI_CLI_TENANCY: ${{ secrets.OCI_CLI_TENANCY }}
          OCI_CLI_REGION: ${{ secrets.OCI_CLI_REGION }}
          OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_CLI_KEY_CONTENT }}
          OCI_CLI_SUPPRESS_FILE_PERMISSIONS_WARNING: "True"
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          
          # Sprawd≈∫ czy wszystkie secrets sƒÖ ustawione
          if [ -z "$OCI_CLI_USER" ]; then
            echo "‚ùå Secret OCI_CLI_USER nie jest ustawiony!"
            exit 1
          fi
          
          if [ -z "$OCI_CLI_TENANCY" ]; then
            echo "‚ùå Secret OCI_CLI_TENANCY nie jest ustawiony!"
            exit 1
          fi
          
          if [ -z "$OCI_CLI_FINGERPRINT" ]; then
            echo "‚ùå Secret OCI_CLI_FINGERPRINT nie jest ustawiony!"
            exit 1
          fi
          
          if [ -z "$OCI_CLI_REGION" ]; then
            echo "‚ùå Secret OCI_CLI_REGION nie jest ustawiony!"
            exit 1
          fi
          
          if [ -z "$OCI_CLI_KEY_CONTENT" ]; then
            echo "‚ùå Secret OCI_CLI_KEY_CONTENT nie jest ustawiony!"
            exit 1
          fi
          
          echo "‚úÖ Wszystkie wymagane secrets sƒÖ ustawione"
          
          # Utw√≥rz katalog konfiguracyjny
          mkdir -p ~/.oci
          chmod 700 ~/.oci
          
          # Utw√≥rz plik konfiguracyjny
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=$OCI_CLI_USER
          fingerprint=$OCI_CLI_FINGERPRINT
          tenancy=$OCI_CLI_TENANCY
          region=$OCI_CLI_REGION
          key_file=~/.oci/key.pem
          EOF
          
          chmod 600 ~/.oci/config
          
          # Zapisz klucz prywatny
          echo "$OCI_CLI_KEY_CONTENT" > ~/.oci/key.pem
          chmod 600 ~/.oci/key.pem
          
          echo "‚úÖ OCI CLI skonfigurowane"
          echo ""
          echo "üìã Konfiguracja (bez kluczy):"
          cat ~/.oci/config
      
      - name: Test OCI Connection
        env:
          OCI_CLI_SUPPRESS_FILE_PERMISSIONS_WARNING: "True"
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          
          echo "üîç Testowanie po≈ÇƒÖczenia z OCI..."
          
          if oci os ns get; then
            echo "‚úÖ Po≈ÇƒÖczenie z OCI dzia≈Ça poprawnie!"
          else
            echo "‚ùå Nie mo≈ºna po≈ÇƒÖczyƒá siƒô z OCI"
            exit 1
          fi
      
      - name: Check ARM Instance Availability
        env:
          OCI_CLI_SUPPRESS_FILE_PERMISSIONS_WARNING: "True"
          COMPARTMENT_ID: ${{ secrets.COMPARTMENT_ID }}
          SUBNET_ID: ${{ secrets.SUBNET_ID }}
          SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          
          echo "üîç Sprawdzanie dostƒôpno≈õci ARM instances..."
          
          # Lista dostƒôpnych ARM shapes
          echo ""
          echo "üìä Dostƒôpne ARM shapes:"
          oci compute shape list \
            --compartment-id "$COMPARTMENT_ID" \
            --all \
            --query 'data[?contains(shape, `A1`) == `true`].{Shape:shape, OCPUs:"ocpus", Memory:"memory-in-g-bs"}' \
            --output table
          
          # Lista istniejƒÖcych instancji
          echo ""
          echo "üìã IstniejƒÖce instancje:"
          oci compute instance list \
            --compartment-id "$COMPARTMENT_ID" \
            --all \
            --output table \
            --query 'data[*].{Name:"display-name", Shape:shape, State:"lifecycle-state", Created:"time-created"}' \
            || echo "‚ö†Ô∏è Brak instancji"
          
          # Lista instancji ARM
          echo ""
          echo "üí™ IstniejƒÖce instancje ARM:"
          oci compute instance list \
            --compartment-id "$COMPARTMENT_ID" \
            --all \
            --query 'data[?contains(shape, `A1`) == `true`].{Name:"display-name", Shape:shape, State:"lifecycle-state"}' \
            --output table \
            || echo "‚ö†Ô∏è Brak instancji ARM"
          
          echo ""
          echo "‚úÖ Sprawdzanie zako≈Ñczone"
      
      - name: Try Create ARM Instance (Optional)
        id: create
        if: false  # Zmie≈Ñ na true je≈õli chcesz pr√≥bowaƒá tworzyƒá instancjƒô
        env:
          OCI_CLI_SUPPRESS_FILE_PERMISSIONS_WARNING: "True"
          COMPARTMENT_ID: ${{ secrets.COMPARTMENT_ID }}
          SUBNET_ID: ${{ secrets.SUBNET_ID }}
          SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
        continue-on-error: true
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          
          echo "üöÄ Pr√≥ba utworzenia instancji ARM..."
          
          # Pobierz dostƒôpne availability domains
          AD=$(oci iam availability-domain list \
            --compartment-id "$COMPARTMENT_ID" \
            --query 'data[0].name' \
            --raw-output)
          
          echo "Availability Domain: $AD"
          
          # Pobierz najnowszy obraz Ubuntu ARM
          IMAGE_ID=$(oci compute image list \
            --compartment-id "$COMPARTMENT_ID" \
            --operating-system "Canonical Ubuntu" \
            --shape "VM.Standard.A1.Flex" \
            --sort-by TIMECREATED \
            --sort-order DESC \
            --limit 1 \
            --query 'data[0].id' \
            --raw-output)
          
          echo "Image ID: $IMAGE_ID"
          
          # Pr√≥ba utworzenia instancji
          oci compute instance launch \
            --availability-domain "$AD" \
            --compartment-id "$COMPARTMENT_ID" \
            --shape "VM.Standard.A1.Flex" \
            --shape-config '{"ocpus":4,"memoryInGBs":24}' \
            --image-id "$IMAGE_ID" \
            --subnet-id "$SUBNET_ID" \
            --display-name "arm-instance-$(date +%Y%m%d-%H%M%S)" \
            --assign-public-ip true \
            --ssh-authorized-keys-file <(echo "$SSH_PUBLIC_KEY") \
            --wait-for-state RUNNING \
            && echo "‚úÖ Instancja utworzona!" \
            || echo "‚ö†Ô∏è Brak dostƒôpnej capacity"
      
      - name: Cleanup
        if: always()
        run: |
          rm -rf ~/.oci
          echo "‚úÖ Cleanup zako≈Ñczony"
